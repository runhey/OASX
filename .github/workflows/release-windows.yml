on:
  push:
    tags: 
        - 'v*'
    # branches: 
    #   - master
name: Build-Release[Windows]


jobs:
    build_and_package:
        runs-on: windows-latest
        # é…ç½®ç¯å¢ƒ
        steps:
        - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
        - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
        - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
        # ä¸‹æ‹‰ä»“åº“
        - name: Check out repository code
          uses: actions/checkout@v3
        # ä¸‹è½½ Flutter
        - name: Setup Flutter
          uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.27.1'
            channel: 'stable'
        - name: List files in the repository
          run: |
            echo '' > ${{ secrets.OASX_RELEASE }}
            ls ${{ github.workspace }}
        - name: Build Window
          uses: DamianReeves/write-file-action@master
          with:
            path: ${{ secrets.WINDOWS_PATH_KEY }}
            contents: ${{ secrets.WINDOWS_PATH_VALUES }}
            write-mode: append
        - run: echo "ğŸ This job's status is ${{ job.status }}."
        - run: flutter --version
        - name: "Read file contents"
          uses: andstor/file-reader-action@v1
          with:
            path: ${{ secrets.WINDOWS_PATH_KEY }}
        # ä¸‹è½½ä¾èµ–
        - name: Install dependencies
          run: flutter pub get
        # æœ€æ–°çš„å‘å¸ƒurl
        - name: Get latest release
          id: get_release
          uses: actions/github-script@v4
          with:
            github-token: ${{ secrets.RELEASE_TOKEN }}
            script: |
              const { data: releases } = await github.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              const latestRelease = releases[0];
              const version = latestRelease.tag_name.replace(/^v/, '') + '+1'
              console.log(JSON.stringify(latestRelease, null, 2));
              core.setOutput('upload_url', latestRelease.upload_url);
              core.setOutput('tag_name', latestRelease.tag_name);
              core.setOutput('version', version);
        # ä¿®æ”¹ yaml ç‰ˆæœ¬å·
        - name: Update version
          uses: fjogeleit/yaml-update-action@main
          with:
            valueFile: 'pubspec.yaml'
            propertyPath: 'version'
            value: ${{ steps.get_release.outputs.version }}
            commitChange: false
        # æ„å»º
        - name: Build Flutter Windows app
          id: build
          run: flutter build windows
        # å®‰è£…UPX
        - name: Install UPX
          run: |
            choco install upx -y
            echo "UPX version:"
            upx --version
        # ä½¿ç”¨UPXä¼˜åŒ–ä½“ç§¯
        - name: Compress exe/dll with UPX
          run: |
            cd build/windows/x64/runner/Release
            upx --best --lzma *.exe || true
            upx --best --lzma *.dll || true
        # æ‰“åŒ…
        - name: Package Release zip
          run: |
            cd build/windows/x64/runner/Release
            7z a ${{ github.workspace }}/build/oasx_${{ steps.get_release.outputs.tag_name }}_windows.zip *
        # å‘å¸ƒåˆ° Release
        - name: Upload Release Windows
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          with:
            upload_url: ${{ steps.get_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
            asset_path: ./build/oasx_${{ steps.get_release.outputs.tag_name }}_windows.zip
            asset_name: oasx_${{ steps.get_release.outputs.tag_name }}_windows.zip
            asset_content_type: application/gzip