on:
  push:
    branches: 
      - master
name: Build-Release[Web]


jobs:
    build_and_package:
        runs-on: ubuntu-latest
        # é…ç½®ç¯å¢ƒ
        steps:
        - run: echo "ğŸ‰ The job was automatically triggered by a ${{ github.event_name }} event."
        - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
        - run: echo "ğŸ” The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
        # ä¸‹æ‹‰ä»“åº“
        - name: Check out repository code
          uses: actions/checkout@v3
        # ä¸‹è½½ Flutter
        - name: Setup Flutter
          uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.27.1'
            channel: 'stable'
        - name: List files in the repository
          run: |
            echo '' > ${{ secrets.OASX_RELEASE }}
            ls ${{ github.workspace }}
        - run: echo "ğŸ This job's status is ${{ job.status }}."
        - run: flutter --version
        - name: "Read file contents"
          uses: andstor/file-reader-action@v1
          with:
            path: ${{ secrets.WINDOWS_PATH_KEY }}
        # ä¸‹è½½ä¾èµ–
        - name: Install dependencies
          run: flutter pub get
        # æœ€æ–°çš„å‘å¸ƒurl
        - name: Get latest release
          id: get_release
          uses: actions/github-script@v4
          with:
            github-token: ${{ secrets.RELEASE_TOKEN }}
            script: |
              const { data: releases } = await github.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              const latestRelease = releases[0];
              const version = latestRelease.tag_name.replace(/^v/, '') + '+1'
              console.log(JSON.stringify(latestRelease, null, 2));
              core.setOutput('upload_url', latestRelease.upload_url);
              core.setOutput('tag_name', latestRelease.tag_name);
              core.setOutput('version', version);
        # ä¿®æ”¹ yaml ç‰ˆæœ¬å·
        - name: Update version
          uses: fjogeleit/yaml-update-action@main
          with:
            valueFile: 'pubspec.yaml'
            propertyPath: 'version'
            value: ${{ steps.get_release.outputs.version }}
            commitChange: false
        # æ„å»º
        - name: Build Flutter Web App
          id: build
          run: flutter build web --web-renderer canvaskit --base-href="/OASX/"
        # # æ‰“åŒ…
        # - name: Package oasx
        #   id: package
        #   uses: actions/setup-python@v4
        #   with:
        #     python-version: '3.10'
        # - run: |
        #     python ./script/release_windows_package.py --version ${{ steps.get_release.outputs.tag_name }}

        # å‘å¸ƒåˆ° Release
        - name: Upload Release Web
          uses: JamesIves/github-pages-deploy-action@v4
          with:
            token: ${{ secrets.RELEASE_TOKEN }}
            branch: page
            folder: build/web # é™æ€æ–‡ä»¶çš„è·¯å¾„

